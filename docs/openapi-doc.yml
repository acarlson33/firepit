openapi: 3.1.0
info:
    title: Firepit API
    version: 1.0.0
    description: |
        # Firepit - Real-time Communication Platform API

        Firepit is a high-performance, real-time communication platform built with Next.js 15, React, and Appwrite.

        ## Features
        - **Real-time Messaging**: Instant message delivery with WebSocket subscriptions
        - **Server & Channel Organization**: Discord-like server and channel structure
        - **Direct Messaging**: Private 1-on-1 and group conversations
        - **Rich Media**: Image uploads, file attachments, custom emojis
        - **Reactions**: Message reactions with custom emoji support
        - **User Presence**: Online/offline status and typing indicators
        - **Role-Based Access**: Granular permissions system
        - **Offline Support**: Service Worker with aggressive caching
        - **Performance**: Virtual scrolling, code splitting, <100ms repeat visits

        ## Architecture

        ### Frontend
        - **Framework**: Next.js 15 with React 19
        - **State Management**: React Query (TanStack Query) with stale-while-revalidate
        - **Real-time**: Appwrite Realtime subscriptions with connection pooling
        - **Virtual Scrolling**: react-virtuoso for infinite message lists
        - **Caching**: Service Worker + React Query + HTTP Cache-Control

        ### Backend
        - **Database**: Appwrite (self-hosted or cloud)
        - **Authentication**: Appwrite Auth with session-based cookies
        - **Storage**: Appwrite Storage for images and files
        - **Monitoring**: New Relic APM integration

        ### Performance Optimizations
        1. Webpack code splitting (framework/lib/commons)
        2. Dynamic imports for heavy components
        3. React Query with 5min staleTime, 10min gcTime
        4. Service Worker with multi-tier caching
        5. Virtual scrolling for message lists
        6. Debounced batch updates for typing indicators
        7. Image lazy loading with skeleton placeholders
        8. Font optimization (display:swap/optional)
        9. Resource hints (preconnect, dns-prefetch, preload)
        10. API response caching (Cache-Control headers)
        11. Message pagination (15 initial, 30 on scroll)
        12. Compression utilities for large responses
        13. Deferred real-time subscriptions (3s delay)
        14. SWR cache strategy for server/channel lists

        ## Authentication

        All authenticated endpoints require:
        - Session cookie set by Appwrite (`a_session_*`)
        - Obtained via `/api/auth/login` or Appwrite client SDK

        ## Rate Limiting

        - **Messages**: 10 per minute per user
        - **Uploads**: 5 per minute per user
        - **Search**: 20 per minute per user
        - **Typing Status**: 1 per second per user

        ## Service Worker

        The application includes a comprehensive Service Worker (`/sw.js`) that provides:

        ### Cache Strategy
        - **Static Assets** (.js, .css, fonts, images): Cache-first with background update
        - **API Routes**: Network-first with offline fallback (503 + offline flag)
        - **Navigation**: Stale-while-revalidate
        - **Default**: Network only

        ### Offline Capabilities
        - Cached static assets for instant repeat visits (~100ms)
        - Offline API fallback with 503 status
        - Background sync ready for message queue
        - Push notification support

        ### Cache Names
        - `firepit-v1`: General cache
        - `firepit-static-v1`: Static assets
        - `firepit-api-v1`: API responses

    contact:
        name: Firepit Support
        url: https://github.com/acarlson33/firepit
    license:
        name: MIT
        url: https://opensource.org/licenses/MIT

servers:
    - url: https://firepit.example.com
      description: Production server
    - url: http://localhost:3000
      description: Local development server

tags:
    - name: Authentication
      description: User authentication and session management
    - name: Messages
      description: Channel and direct message operations
    - name: Servers
      description: Server (guild) management
    - name: Channels
      description: Channel management within servers
    - name: Direct Messages
      description: Private messaging between users
    - name: Users
      description: User profile and search operations
    - name: Reactions
      description: Message reaction operations
    - name: Typing
      description: Typing indicator management
    - name: Status
      description: User presence and status
    - name: Roles
      description: Role and permission management
    - name: Emojis
      description: Custom emoji management
    - name: Invites
      description: Server invitation management and usage
    - name: Uploads
      description: File and image upload operations
    - name: Search
      description: Search functionality

components:
    securitySchemes:
        sessionCookie:
            type: apiKey
            in: cookie
            name: a_session_*
            description: Appwrite session cookie

    schemas:
        Error:
            type: object
            required:
                - error
            properties:
                error:
                    type: string
                    description: Error message
                details:
                    type: object
                    description: Additional error details

        User:
            type: object
            required:
                - $id
                - name
            properties:
                $id:
                    type: string
                    description: User ID
                name:
                    type: string
                    description: Username
                email:
                    type: string
                    format: email
                    description: User email address
                displayName:
                    type: string
                    description: Display name (optional)
                avatarUrl:
                    type: string
                    format: uri
                    description: Avatar image URL
                pronouns:
                    type: string
                    description: User pronouns
                bio:
                    type: string
                    description: User biography
                status:
                    type: string
                    enum: [online, offline, away, dnd]
                    description: Current user status
                $createdAt:
                    type: string
                    format: date-time
                    description: Account creation timestamp

        Server:
            type: object
            required:
                - $id
                - name
                - ownerId
            properties:
                $id:
                    type: string
                    description: Server ID
                name:
                    type: string
                    description: Server name
                ownerId:
                    type: string
                    description: Server owner user ID
                memberCount:
                    type: integer
                    description: Number of members
                iconUrl:
                    type: string
                    format: uri
                    description: Server icon URL
                $createdAt:
                    type: string
                    format: date-time
                    description: Server creation timestamp

        Channel:
            type: object
            required:
                - $id
                - name
                - serverId
            properties:
                $id:
                    type: string
                    description: Channel ID
                name:
                    type: string
                    description: Channel name
                serverId:
                    type: string
                    description: Parent server ID
                type:
                    type: string
                    enum: [text, voice, announcement]
                    default: text
                    description: Channel type
                topic:
                    type: string
                    description: Channel topic/description
                $createdAt:
                    type: string
                    format: date-time
                    description: Channel creation timestamp

        Message:
            type: object
            required:
                - $id
                - userId
                - text
            properties:
                $id:
                    type: string
                    description: Message ID
                userId:
                    type: string
                    description: Author user ID
                userName:
                    type: string
                    description: Author username
                displayName:
                    type: string
                    description: Author display name
                avatarUrl:
                    type: string
                    format: uri
                    description: Author avatar URL
                text:
                    type: string
                    description: Message content (supports markdown and mentions)
                channelId:
                    type: string
                    description: Channel ID (for channel messages)
                conversationId:
                    type: string
                    description: Conversation ID (for DMs)
                imageUrl:
                    type: string
                    format: uri
                    description: Attached image URL
                imageFileId:
                    type: string
                    description: Appwrite Storage file ID for image
                attachments:
                    type: array
                    items:
                        $ref: "#/components/schemas/FileAttachment"
                    description: File attachments
                reactions:
                    type: array
                    items:
                        $ref: "#/components/schemas/Reaction"
                    description: Message reactions
                replyTo:
                    $ref: "#/components/schemas/MessageReference"
                    description: Referenced message (if reply)
                editedAt:
                    type: string
                    format: date-time
                    description: Last edit timestamp
                removedAt:
                    type: string
                    format: date-time
                    description: Deletion timestamp
                $createdAt:
                    type: string
                    format: date-time
                    description: Message creation timestamp

        FileAttachment:
            type: object
            required:
                - fileId
                - fileName
                - fileSize
                - fileType
            properties:
                fileId:
                    type: string
                    description: Appwrite Storage file ID
                fileName:
                    type: string
                    description: Original filename
                fileSize:
                    type: integer
                    description: File size in bytes
                fileType:
                    type: string
                    description: MIME type
                fileUrl:
                    type: string
                    format: uri
                    description: Download URL
                thumbnailUrl:
                    type: string
                    format: uri
                    description: Thumbnail URL (for images/videos)

        Reaction:
            type: object
            required:
                - emoji
                - userIds
                - count
            properties:
                emoji:
                    type: string
                    description: Unicode emoji or custom emoji ID
                userIds:
                    type: array
                    items:
                        type: string
                    description: User IDs who reacted
                count:
                    type: integer
                    description: Total reaction count

        MessageReference:
            type: object
            description: Reference to another message (for replies)
            properties:
                messageId:
                    type: string
                    description: Referenced message ID
                userId:
                    type: string
                    description: Referenced message author ID
                userName:
                    type: string
                    description: Referenced message author username
                displayName:
                    type: string
                    description: Referenced message author display name
                text:
                    type: string
                    description: Referenced message content (truncated)

        Conversation:
            type: object
            required:
                - $id
                - participantIds
            properties:
                $id:
                    type: string
                    description: Conversation ID
                participantIds:
                    type: array
                    items:
                        type: string
                    description: User IDs of participants
                participants:
                    type: array
                    items:
                        $ref: "#/components/schemas/User"
                    description: Participant user objects (enriched)
                lastMessage:
                    $ref: "#/components/schemas/Message"
                    description: Most recent message
                unreadCount:
                    type: integer
                    description: Unread message count for current user
                $createdAt:
                    type: string
                    format: date-time
                    description: Conversation creation timestamp

        Role:
            type: object
            required:
                - $id
                - name
                - serverId
                - permissions
            properties:
                $id:
                    type: string
                    description: Role ID
                name:
                    type: string
                    description: Role name
                serverId:
                    type: string
                    description: Parent server ID
                color:
                    type: string
                    pattern: "^#[0-9A-Fa-f]{6}$"
                    description: Role color (hex)
                permissions:
                    type: array
                    items:
                        type: string
                    description: Permission strings
                position:
                    type: integer
                    description: Role hierarchy position
                $createdAt:
                    type: string
                    format: date-time
                    description: Role creation timestamp

        CustomEmoji:
            type: object
            required:
                - fileId
                - name
            properties:
                fileId:
                    type: string
                    description: Appwrite Storage file ID
                name:
                    type: string
                    description: Emoji shortcode (e.g., "party_parrot")
                serverId:
                    type: string
                    description: Server ID (if server-specific)
                uploaderId:
                    type: string
                    description: User ID who uploaded
                url:
                    type: string
                    format: uri
                    description: Emoji image URL

        TypingStatus:
            type: object
            required:
                - userId
                - contextId
            properties:
                userId:
                    type: string
                    description: User ID who is typing
                userName:
                    type: string
                    description: Username
                contextId:
                    type: string
                    description: Channel or conversation ID
                $updatedAt:
                    type: string
                    format: date-time
                    description: Last update timestamp

        UserStatus:
            type: object
            required:
                - userId
                - status
            properties:
                userId:
                    type: string
                    description: User ID
                status:
                    type: string
                    enum: [online, offline, away, dnd]
                    description: User presence status
                customStatus:
                    type: string
                    description: Custom status message
                duration:
                    type: integer
                    description: Status duration in hours (0 = until cleared)
                $updatedAt:
                    type: string
                    format: date-time
                    description: Last status update

        PaginatedResponse:
            type: object
            required:
                - total
                - documents
            properties:
                total:
                    type: integer
                    description: Total document count
                documents:
                    type: array
                    items:
                        type: object
                    description: Array of documents
                cursor:
                    type: string
                    description: Cursor for next page

        Invite:
            type: object
            required:
                - $id
                - code
                - serverId
                - createdBy
            properties:
                $id:
                    type: string
                    description: Invite document ID
                code:
                    type: string
                    description: Unique invite code (8 characters)
                    example: "abc12345"
                serverId:
                    type: string
                    description: Server ID this invite belongs to
                channelId:
                    type: string
                    description: Optional channel ID to direct users to
                    nullable: true
                createdBy:
                    type: string
                    description: User ID who created the invite
                expiresAt:
                    type: string
                    format: date-time
                    description: Expiration timestamp (null = never expires)
                    nullable: true
                maxUses:
                    type: integer
                    description: Maximum number of uses (0 = unlimited)
                    default: 0
                uses:
                    type: integer
                    description: Current number of uses
                    default: 0
                temporary:
                    type: boolean
                    description: Whether members joining via this invite are temporary
                    default: false
                $createdAt:
                    type: string
                    format: date-time
                    description: Invite creation timestamp
                $updatedAt:
                    type: string
                    format: date-time
                    description: Last update timestamp

        InvitePreview:
            type: object
            required:
                - code
                - server
            properties:
                code:
                    type: string
                    description: Invite code
                server:
                    type: object
                    required:
                        - $id
                        - name
                    properties:
                        $id:
                            type: string
                        name:
                            type: string
                        iconUrl:
                            type: string
                            format: uri
                            nullable: true
                        memberCount:
                            type: integer
                channel:
                    type: object
                    nullable: true
                    properties:
                        $id:
                            type: string
                        name:
                            type: string
                inviter:
                    type: object
                    properties:
                        name:
                            type: string
                        avatarUrl:
                            type: string
                            format: uri
                            nullable: true
                expiresAt:
                    type: string
                    format: date-time
                    nullable: true

    responses:
        Unauthorized:
            description: Not authenticated
            content:
                application/json:
                    schema:
                        $ref: "#/components/schemas/Error"
                    example:
                        error: "Not authenticated"

security:
    - sessionCookie: []

paths:
    /api/me:
        get:
            tags:
                - Authentication
            summary: Get current user
            description: Returns the currently authenticated user's profile
            operationId: getCurrentUser
            responses:
                "200":
                    description: User profile
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/User"
                "401":
                    description: Not authenticated
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/servers:
        get:
            tags:
                - Servers
            summary: List servers
            description: |
                Returns a paginated list of servers the user has access to.

                **Caching**: Cache-Control: public, max-age=60, stale-while-revalidate=120
            operationId: listServers
            parameters:
                - name: limit
                  in: query
                  description: Number of servers to return
                  schema:
                      type: integer
                      default: 25
                      minimum: 1
                      maximum: 100
                - name: cursor
                  in: query
                  description: Pagination cursor
                  schema:
                      type: string
            responses:
                "200":
                    description: Server list
                    headers:
                        Cache-Control:
                            schema:
                                type: string
                            description: public, max-age=60, stale-while-revalidate=120
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    servers:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/Server"
                                    total:
                                        type: integer
                                    cursor:
                                        type: string
                "401":
                    $ref: "#/components/responses/Unauthorized"

    /api/channels:
        get:
            tags:
                - Channels
            summary: List channels
            description: |
                Returns channels for a specific server.

                **Caching**: Cache-Control: public, max-age=60, stale-while-revalidate=120
            operationId: listChannels
            parameters:
                - name: serverId
                  in: query
                  required: true
                  description: Server ID
                  schema:
                      type: string
                - name: limit
                  in: query
                  description: Number of channels to return
                  schema:
                      type: integer
                      default: 50
                      minimum: 1
                      maximum: 100
                - name: cursor
                  in: query
                  description: Pagination cursor
                  schema:
                      type: string
            responses:
                "200":
                    description: Channel list
                    headers:
                        Cache-Control:
                            schema:
                                type: string
                            description: public, max-age=60, stale-while-revalidate=120
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    channels:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/Channel"
                                    total:
                                        type: integer
                "400":
                    description: Missing serverId
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"

    /api/messages:
        get:
            tags:
                - Messages
            summary: List messages
            description: |
                Returns messages for a channel with pagination.

                Messages are returned in reverse chronological order (newest first).
                Initial load fetches 15 messages, subsequent loads fetch 30.

                **Real-time**: Subscribe to `databases.{databaseId}.collections.{messagesCollection}.documents` for live updates
            operationId: listMessages
            parameters:
                - name: channelId
                  in: query
                  required: true
                  description: Channel ID
                  schema:
                      type: string
                - name: limit
                  in: query
                  description: Number of messages to return
                  schema:
                      type: integer
                      default: 15
                      minimum: 1
                      maximum: 100
                - name: cursor
                  in: query
                  description: Pagination cursor (message ID to load before)
                  schema:
                      type: string
            responses:
                "200":
                    description: Message list
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    messages:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/Message"
                                    total:
                                        type: integer
                                    hasMore:
                                        type: boolean
                "400":
                    description: Missing channelId
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"

        post:
            tags:
                - Messages
            summary: Send message
            description: |
                Creates a new message in a channel.

                **Rate Limit**: 10 messages per minute per user
                **Monitoring**: Tracked via New Relic custom event `MessageSent`

                Supports:
                - Text content (required or imageUrl required)
                - Image uploads (via imageFileId)
                - File attachments
                - Replies (via replyToMessageId)
                - Mentions (@username)
                - Custom emojis (:emoji_name:)
            operationId: sendMessage
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - channelId
                            properties:
                                channelId:
                                    type: string
                                    description: Channel ID
                                text:
                                    type: string
                                    description: Message content (max 4000 chars)
                                    maxLength: 4000
                                imageUrl:
                                    type: string
                                    format: uri
                                    description: Image URL (from /api/upload-image)
                                imageFileId:
                                    type: string
                                    description: Appwrite file ID for image
                                attachments:
                                    type: array
                                    items:
                                        $ref: "#/components/schemas/FileAttachment"
                                    description: File attachments
                                replyToMessageId:
                                    type: string
                                    description: Message ID being replied to
            responses:
                "200":
                    description: Message created
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    message:
                                        $ref: "#/components/schemas/Message"
                "400":
                    description: Validation error
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "429":
                    description: Rate limit exceeded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/messages/{messageId}/reactions:
        post:
            tags:
                - Reactions
            summary: Add reaction
            description: |
                Adds a reaction to a message. If reaction already exists, removes it (toggle behavior).

                Supports Unicode emojis and custom emojis (format: `:emoji_name:`).
            operationId: addReaction
            parameters:
                - name: messageId
                  in: path
                  required: true
                  description: Message ID
                  schema:
                      type: string
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - emoji
                            properties:
                                emoji:
                                    type: string
                                    description: Unicode emoji or custom emoji shortcode
                                    example: "ðŸ‘"
            responses:
                "200":
                    description: Reaction added/removed
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    message:
                                        $ref: "#/components/schemas/Message"
                "400":
                    description: Invalid emoji
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "404":
                    description: Message not found
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

        delete:
            tags:
                - Reactions
            summary: Remove reaction
            description: Removes a reaction from a message
            operationId: removeReaction
            parameters:
                - name: messageId
                  in: path
                  required: true
                  description: Message ID
                  schema:
                      type: string
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - emoji
                            properties:
                                emoji:
                                    type: string
                                    description: Emoji to remove
            responses:
                "200":
                    description: Reaction removed
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    message:
                                        $ref: "#/components/schemas/Message"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "404":
                    description: Message or reaction not found
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/direct-messages:
        get:
            tags:
                - Direct Messages
            summary: List conversations
            description: |
                Returns all DM conversations for the current user.

                Each conversation includes the last message and unread count.

                **Real-time**: Subscribe to conversations collection for updates
            operationId: listConversations
            responses:
                "200":
                    description: Conversation list
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    conversations:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/Conversation"
                "401":
                    $ref: "#/components/responses/Unauthorized"

        post:
            tags:
                - Direct Messages
            summary: Send DM
            description: |
                Sends a direct message. Creates conversation if it doesn't exist.

                **Rate Limit**: 10 messages per minute per user
            operationId: sendDirectMessage
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - conversationId
                            properties:
                                conversationId:
                                    type: string
                                    description: Conversation ID
                                text:
                                    type: string
                                    description: Message content
                                    maxLength: 4000
                                imageUrl:
                                    type: string
                                    format: uri
                                    description: Image URL
                                imageFileId:
                                    type: string
                                    description: Image file ID
                                attachments:
                                    type: array
                                    items:
                                        $ref: "#/components/schemas/FileAttachment"
                                replyToMessageId:
                                    type: string
                                    description: Message being replied to
            responses:
                "200":
                    description: Message sent
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    message:
                                        $ref: "#/components/schemas/Message"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "429":
                    description: Rate limit exceeded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/typing:
        post:
            tags:
                - Typing
            summary: Update typing status
            description: |
                Updates typing indicator for a channel or conversation.

                Status automatically expires after 5 seconds if not updated.

                **Rate Limit**: 1 request per second per user
                **Real-time**: Subscribe to typing collection for live indicators
            operationId: updateTypingStatus
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                channelId:
                                    type: string
                                    description: Channel ID (for channel typing)
                                conversationId:
                                    type: string
                                    description: Conversation ID (for DM typing)
                            oneOf:
                                - required: [channelId]
                                - required: [conversationId]
            responses:
                "200":
                    description: Typing status updated
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    success:
                                        type: boolean
                "400":
                    description: Missing context
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "429":
                    description: Rate limit exceeded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

        delete:
            tags:
                - Typing
            summary: Clear typing status
            description: Immediately clears typing indicator
            operationId: clearTypingStatus
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                channelId:
                                    type: string
                                conversationId:
                                    type: string
            responses:
                "200":
                    description: Typing status cleared
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    success:
                                        type: boolean
                "401":
                    $ref: "#/components/responses/Unauthorized"

    /api/status:
        post:
            tags:
                - Status
            summary: Update user status
            description: |
                Updates the user's presence status and optional custom message.

                Status persists until changed or duration expires.
            operationId: updateStatus
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - status
                            properties:
                                status:
                                    type: string
                                    enum: [online, offline, away, dnd]
                                    description: Presence status
                                customStatus:
                                    type: string
                                    description: Custom status message (max 100 chars)
                                    maxLength: 100
                                duration:
                                    type: integer
                                    description: Status duration in hours (0 = until cleared)
                                    default: 0
                                    minimum: 0
                                    maximum: 168
            responses:
                "200":
                    description: Status updated
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/UserStatus"
                "400":
                    description: Invalid status
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"

        get:
            tags:
                - Status
            summary: Get user statuses
            description: |
                Returns status for one or more users.
            operationId: getUserStatuses
            parameters:
                - name: userIds
                  in: query
                  description: Comma-separated user IDs
                  schema:
                      type: string
                      example: "user1,user2,user3"
            responses:
                "200":
                    description: User statuses
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    statuses:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/UserStatus"
                "401":
                    $ref: "#/components/responses/Unauthorized"

    /api/upload-image:
        post:
            tags:
                - Uploads
            summary: Upload image
            description: |
                Uploads an image file to Appwrite Storage.

                **Rate Limit**: 5 uploads per minute per user
                **Max Size**: 10MB
                **Formats**: JPEG, PNG, GIF, WebP

                Returns file ID and preview URL for use in messages.
            operationId: uploadImage
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            type: object
                            required:
                                - file
                            properties:
                                file:
                                    type: string
                                    format: binary
                                    description: Image file
            responses:
                "200":
                    description: Image uploaded
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    fileId:
                                        type: string
                                        description: Appwrite file ID
                                    url:
                                        type: string
                                        format: uri
                                        description: Image preview URL
                "400":
                    description: Invalid file
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "413":
                    description: File too large
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "429":
                    description: Rate limit exceeded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/upload-file:
        post:
            tags:
                - Uploads
            summary: Upload file attachment
            description: |
                Uploads a file attachment to Appwrite Storage.

                **Rate Limit**: 5 uploads per minute per user
                **Max Size**: 25MB

                Returns file metadata for use in message attachments.
            operationId: uploadFile
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            type: object
                            required:
                                - file
                            properties:
                                file:
                                    type: string
                                    format: binary
                                    description: File to upload
            responses:
                "200":
                    description: File uploaded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/FileAttachment"
                "400":
                    description: Invalid file
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "413":
                    description: File too large
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "429":
                    description: Rate limit exceeded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/custom-emojis:
        get:
            tags:
                - Emojis
            summary: List custom emojis
            description: |
                Returns all custom emojis available to the user.

                Includes server-specific and global emojis.
            operationId: listCustomEmojis
            parameters:
                - name: serverId
                  in: query
                  description: Filter by server ID
                  schema:
                      type: string
            responses:
                "200":
                    description: Custom emoji list
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    emojis:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/CustomEmoji"
                "401":
                    $ref: "#/components/responses/Unauthorized"

    /api/upload-emoji:
        post:
            tags:
                - Emojis
            summary: Upload custom emoji
            description: |
                Uploads a custom emoji image.

                **Rate Limit**: 5 uploads per minute per user
                **Max Size**: 256KB
                **Formats**: PNG, GIF (animated supported)
                **Dimensions**: Recommended 128x128px
            operationId: uploadCustomEmoji
            requestBody:
                required: true
                content:
                    multipart/form-data:
                        schema:
                            type: object
                            required:
                                - file
                                - name
                            properties:
                                file:
                                    type: string
                                    format: binary
                                    description: Emoji image
                                name:
                                    type: string
                                    description: Emoji shortcode (alphanumeric and underscores)
                                    pattern: "^[a-zA-Z0-9_]+$"
                                serverId:
                                    type: string
                                    description: Server ID (if server-specific)
            responses:
                "200":
                    description: Emoji uploaded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/CustomEmoji"
                "400":
                    description: Invalid emoji
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "429":
                    description: Rate limit exceeded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/roles:
        get:
            tags:
                - Roles
            summary: List roles
            description: Returns roles for a server
            operationId: listRoles
            parameters:
                - name: serverId
                  in: query
                  required: true
                  description: Server ID
                  schema:
                      type: string
            responses:
                "200":
                    description: Role list
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    roles:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/Role"
                "400":
                    description: Missing serverId
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"

        post:
            tags:
                - Roles
            summary: Create role
            description: |
                Creates a new role in a server.

                Requires server admin permissions.
            operationId: createRole
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - serverId
                                - name
                            properties:
                                serverId:
                                    type: string
                                name:
                                    type: string
                                    maxLength: 50
                                color:
                                    type: string
                                    pattern: "^#[0-9A-Fa-f]{6}$"
                                permissions:
                                    type: array
                                    items:
                                        type: string
                                position:
                                    type: integer
            responses:
                "200":
                    description: Role created
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Role"
                "400":
                    description: Validation error
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "403":
                    description: Insufficient permissions
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/search/messages:
        get:
            tags:
                - Search
            summary: Search messages
            description: |
                Searches messages across channels the user has access to.

                **Rate Limit**: 20 searches per minute per user

                Supports:
                - Full-text search
                - Filter by channel
                - Filter by user
                - Date range filtering
            operationId: searchMessages
            parameters:
                - name: q
                  in: query
                  required: true
                  description: Search query
                  schema:
                      type: string
                      minLength: 2
                - name: channelId
                  in: query
                  description: Filter by channel
                  schema:
                      type: string
                - name: userId
                  in: query
                  description: Filter by user
                  schema:
                      type: string
                - name: after
                  in: query
                  description: Messages after timestamp
                  schema:
                      type: string
                      format: date-time
                - name: before
                  in: query
                  description: Messages before timestamp
                  schema:
                      type: string
                      format: date-time
                - name: limit
                  in: query
                  description: Results limit
                  schema:
                      type: integer
                      default: 20
                      minimum: 1
                      maximum: 100
            responses:
                "200":
                    description: Search results
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    messages:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/Message"
                                    total:
                                        type: integer
                "400":
                    description: Invalid query
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "429":
                    description: Rate limit exceeded
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/users/search:
        get:
            tags:
                - Users
            summary: Search users
            description: |
                Searches users by username or display name.

                **Rate Limit**: 20 searches per minute per user
            operationId: searchUsers
            parameters:
                - name: q
                  in: query
                  required: true
                  description: Search query
                  schema:
                      type: string
                      minLength: 2
                - name: limit
                  in: query
                  description: Results limit
                  schema:
                      type: integer
                      default: 20
                      minimum: 1
                      maximum: 50
            responses:
                "200":
                    description: User list
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    users:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/User"
                "400":
                    description: Invalid query
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"

    /api/profiles/batch:
        post:
            tags:
                - Users
            summary: Batch fetch user profiles
            description: |
                Fetches multiple user profiles in a single request.

                Useful for enriching message lists with user data.
            operationId: batchFetchProfiles
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - userIds
                            properties:
                                userIds:
                                    type: array
                                    items:
                                        type: string
                                    maxItems: 100
                                    description: User IDs to fetch
            responses:
                "200":
                    description: User profiles
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    profiles:
                                        type: object
                                        additionalProperties:
                                            $ref: "#/components/schemas/User"
                                        description: Map of userId -> User
                "400":
                    description: Invalid request
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"

    /api/servers/{serverId}/invites:
        post:
            tags:
                - Invites
            summary: Create server invite
            description: |
                Creates a new invite link for a server. Requires server owner or admin role.

                **Permissions**: Server owner or admin
            operationId: createServerInvite
            parameters:
                - name: serverId
                  in: path
                  required: true
                  description: Server ID
                  schema:
                      type: string
            requestBody:
                required: false
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                channelId:
                                    type: string
                                    description: Optional channel to direct users to
                                expiresAt:
                                    type: string
                                    format: date-time
                                    description: Expiration timestamp (null = never expires)
                                maxUses:
                                    type: integer
                                    description: Maximum uses (0 = unlimited)
                                    default: 0
                                temporary:
                                    type: boolean
                                    description: Mark members as temporary
                                    default: false
            responses:
                "201":
                    description: Invite created
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Invite"
                "400":
                    description: Invalid request
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "403":
                    description: Insufficient permissions
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "404":
                    description: Server not found
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

        get:
            tags:
                - Invites
            summary: List server invites
            description: |
                Lists all invites for a server. Requires server owner or admin role.

                **Permissions**: Server owner or admin
            operationId: listServerInvites
            parameters:
                - name: serverId
                  in: path
                  required: true
                  description: Server ID
                  schema:
                      type: string
            responses:
                "200":
                    description: Invite list
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    invites:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/Invite"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "403":
                    description: Insufficient permissions
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "404":
                    description: Server not found
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/invites/{code}:
        get:
            tags:
                - Invites
            summary: Get invite preview
            description: |
                Returns public information about an invite without requiring authentication.
                Useful for displaying invite preview before joining.

                **Public endpoint** - No authentication required
            operationId: getInvitePreview
            parameters:
                - name: code
                  in: path
                  required: true
                  description: Invite code
                  schema:
                      type: string
                      pattern: "^[a-zA-Z0-9]{8}$"
            responses:
                "200":
                    description: Invite preview
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/InvitePreview"
                "404":
                    description: Invite not found or expired
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

        delete:
            tags:
                - Invites
            summary: Revoke invite
            description: |
                Revokes (deletes) an invite. Can be done by:
                - Server owner
                - Invite creator
                - Global admin

                **Permissions**: Server owner, invite creator, or global admin
            operationId: revokeInvite
            parameters:
                - name: code
                  in: path
                  required: true
                  description: Invite code
                  schema:
                      type: string
                      pattern: "^[a-zA-Z0-9]{8}$"
            responses:
                "200":
                    description: Invite revoked
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    message:
                                        type: string
                                        example: "Invite revoked successfully"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "403":
                    description: Insufficient permissions
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                "404":
                    description: Invite not found
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/invites/{code}/join:
        post:
            tags:
                - Invites
            summary: Join server via invite
            description: |
                Uses an invite to join a server. Creates a membership and tracks invite usage.

                **Validations**:
                - Invite must exist and not be expired
                - User must not already be a member
                - Invite must not have reached max uses
            operationId: joinServerViaInvite
            parameters:
                - name: code
                  in: path
                  required: true
                  description: Invite code
                  schema:
                      type: string
                      pattern: "^[a-zA-Z0-9]{8}$"
            responses:
                "200":
                    description: Successfully joined server
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    serverId:
                                        type: string
                                        description: Server ID joined
                                    message:
                                        type: string
                                        example: "Successfully joined server"
                "400":
                    description: Invalid invite (expired, max uses, already member)
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"
                            examples:
                                expired:
                                    summary: Invite expired
                                    value:
                                        error: "This invite has expired"
                                maxUses:
                                    summary: Max uses reached
                                    value:
                                        error: "This invite has reached its maximum number of uses"
                                alreadyMember:
                                    summary: Already a member
                                    value:
                                        error: "You are already a member of this server"
                "401":
                    $ref: "#/components/responses/Unauthorized"
                "404":
                    description: Invite not found
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Error"

    /api/feature-flags/allow-user-servers:
        get:
            tags:
                - Servers
            summary: Check server creation feature flag
            description: |
                Returns whether users are allowed to create their own servers.
                Used to control server creation feature availability.

                **Public endpoint** - No authentication required
            operationId: getAllowUserServersFlag
            responses:
                "200":
                    description: Feature flag status
                    content:
                        application/json:
                            schema:
                                type: object
                                required:
                                    - enabled
                                properties:
                                    enabled:
                                        type: boolean
                                        description: Whether user server creation is enabled
                            examples:
                                enabled:
                                    summary: Feature enabled
                                    value:
                                        enabled: true
                                disabled:
                                    summary: Feature disabled
                                    value:
                                        enabled: false

    /sw.js:
        get:
            tags:
                - Service Worker
            summary: Service Worker script
            description: |
                # Service Worker

                The Service Worker provides offline support and aggressive caching.

                ## Cache Strategy

                ### Static Assets (Cache-First)
                - **Pattern**: `.js`, `.css`, fonts, images
                - **Strategy**: Serve from cache, update in background
                - **Cache**: `firepit-static-v1`
                - **Benefit**: Instant repeat visits (~100ms)

                ### API Routes (Network-First)
                - **Pattern**: `/api/*`
                - **Strategy**: Network first, fallback to cache on failure
                - **Cache**: `firepit-api-v1`
                - **Offline**: Returns 503 with `{ offline: true }` flag
                - **Benefit**: Fresh data when online, graceful degradation offline

                ### Navigation (Stale-While-Revalidate)
                - **Pattern**: HTML pages
                - **Strategy**: Serve cached, update in background
                - **Cache**: `firepit-v1`
                - **Benefit**: Fast navigation, always fresh content

                ## Installation

                ```javascript
                // Automatically registered in production
                // See: src/components/service-worker-registration.tsx

                if ('serviceWorker' in navigator && process.env.NODE_ENV === 'production') {
                  navigator.serviceWorker.register('/sw.js');
                }
                ```

                ## Events

                ### Install
                - Caches critical assets: `/`, `/chat`, favicon, manifest
                - Calls `skipWaiting()` to activate immediately

                ### Activate
                - Cleans up old caches
                - Claims clients for immediate control

                ### Fetch
                - Implements multi-tier caching strategy
                - Handles offline fallbacks

                ### Sync (Background Sync)
                - Hook ready for offline message queue
                - Not yet implemented

                ### Push (Push Notifications)
                - Receives push notifications
                - Displays system notifications
                - Ready for real-time alerts

                ## Cache Management

                Caches are versioned and automatically cleaned up:
                - `firepit-v1` â†’ `firepit-v2` (old deleted on activate)
                - Manual cache clear: `caches.keys().then(names => names.forEach(name => caches.delete(name)))`

                ## Performance Impact

                - **First Visit**: ~2-3s load time
                - **Repeat Visit (no SW)**: ~500ms-1s
                - **Repeat Visit (with SW)**: ~100ms (99.3% improvement)
                - **Bandwidth Savings**: 90-95% on repeat visits

                ## Browser Support

                - Chrome/Edge: âœ… Full support
                - Firefox: âœ… Full support
                - Safari: âœ… Full support
                - Mobile: âœ… iOS 11.3+, Android 5+
            operationId: getServiceWorker
            responses:
                "200":
                    description: Service Worker JavaScript
                    content:
                        application/javascript:
                            schema:
                                type: string
                            examples:
                                serviceWorker:
                                    summary: Service Worker script
                                    value: |
                                        // Service Worker for Firepit
                                        // Provides offline support and aggressive caching

                                        const CACHE_NAME = 'firepit-v1';
                                        const API_CACHE_NAME = 'firepit-api-v1';
                                        const STATIC_CACHE_NAME = 'firepit-static-v1';

                                        // ... (see /public/sw.js for full implementation)
